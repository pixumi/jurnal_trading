<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jurnal Trading</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #e0f7fa;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }

    .container {
      background-color: #fff;
      width: 95%;
      max-width: 750px;
      margin: 40px 40px;
      padding: 1.5rem;
      padding-left: 16px;
      padding-right: 16px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #0277bd;
      margin-bottom: 24px;
    }

    form {
      display: grid;
      gap: 16px;
      margin-bottom: 30px;
      align-items: center
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    label {
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input, select, textarea {
      padding: 10px 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 15px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
      appearance: none;
      resize: vertical;
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #0288d1;
      outline: none;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      background: transparent;
      color: transparent;
      cursor: pointer;
      height: 100%;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    .date-wrapper {
      position: relative;
    }

    button {
      background-color: #0288d1;
      color: white;
      border: none;
      padding: 12px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #0277bd;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 15px;
    }

    th, td {
      padding: 10px;
      border: 1px solid #b0bec5;
      text-align: center;
      vertical-align: middle;
    }

    th {
      background-color: #b3e5fc;
      color: #01579b;
    }

    .buy-box {
      background-color: #d0f0d2;
      color: #256029;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .sell-box {
      background-color: #f9c0c0;
      color: #9c2b2b;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .win-box {
      background-color: #d0f0d2;
      color: #256029;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .loss-box {
      background-color: #f9c0c0;
      color: #9c2b2b;
      font-weight: bold;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .action-btn {
      background-color: #eeeeee;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 14px;
      margin: 0 2px;
      border-radius: 4px;
    }

    .action-btn:hover {
      background-color: #cccccc;
    }

    .note-cell {
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      color: #0288d1;
      text-decoration: underline;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(1, 87, 155, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .modal-content {
        position: relative;
        background-color: #ffffff;
        padding: 24px;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        color: #01579b;
    }

    .modal-close {
        position: absolute;
        top: 8px;
        right: 8px;
        font-size: 12px;
        background: none;
        border: none;
        color: #01579b;
        cursor: pointer;
        padding: 4px;
        transition: transform 0.2s ease;
    }

   textarea#modalText {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 14px 10px 10px 10px;
        resize: vertical;
        font-family: inherit;
        font-size: 14px;
        box-sizing: border-box;
        margin-top: 14px;
    }

    .modal-close:hover {
        transform: scale(1.2);
    }

    @media (max-width: 600px) {
        .container {
         padding: 1rem;
        }

        .popup-model .content {
            width: 90%;
            padding: 1rem;
        }
        .note-cell {
            max-width: 120px;
        }
    }

    .table-wrapper {
        width: 100%;
        overflow-x: auto;
    }

    .history-table {
        width: 100%;
        min-width: 600px;
        border-collapse: collapse;
    }  

     .switch {
    position: fixed;
    top: 16px;
    right: 16px;
    display: inline-block;
    width: 50px;
    height: 28px;
  }
  .switch input {display:none;}
  .slider {
    position: absolute;
    cursor: pointer;
    background-color: #ccc;
    border-radius: 34px;
    top: 0; left: 0; right: 0; bottom: 0;
    transition: .4s;
  }
  .slider:before {
    position: absolute;
    content: "";
    height: 22px;
    width: 22px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    border-radius: 50%;
    transition: .4s;
  }
  input:checked + .slider {
    background-color: var(--primary-color);
  }
  input:checked + .slider:before {
    transform: translateX(22px);
  }

  /* Analytics Section */
  .analytics-container {
    background-color: #f5f9ff;
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    border: 1px solid #b3e5fc;
  }
  
  .analytics-title {
    text-align: center;
    color: #0277bd;
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 1.4em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  
  .analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
  }
  
  .stat-box {
    background-color: white;
    border-radius: 10px;
    padding: 15px 10px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    border: 1px solid #e1f5fe;
  }
  
  .stat-label {
    font-size: 0.9em;
    color: #01579b;
    margin-bottom: 6px;
    font-weight: 600;
  }
  
  .stat-value {
    font-size: 1.4em;
    font-weight: bold;
    color: #0288d1;
  }
  
  .winrate-value {
    color: #256029;
  }
  
  .lossrate-value {
    color: #c62828;
  }
  
  .profit-factor-value {
    color: #2e7d32;
  }
  
  .stat-subtext {
    font-size: 0.8em;
    color: #78909c;
    margin-top: 4px;
  }
  
  .analytics-chart {
    margin-top: 20px;
    height: 30px;
    background-color: #e1f5fe;
    border-radius: 6px;
    overflow: hidden;
    display: flex;
  }
  
  .win-bar {
    height: 100%;
    background-color: #66bb6a;
    transition: width 0.5s ease;
  }
  
  .loss-bar {
    height: 100%;
    background-color: #ef5350;
    transition: width 0.5s ease;
  }
  
  .chart-labels {
    display: flex;
    justify-content: space-between;
    margin-top: 5px;
    font-size: 0.85em;
    color: #546e7a;
  }

  </style>
</head>

<body>
  
  <div class="container">
    <h1>📜Jurnal Trading📜</h1>
    
    <!-- Analytics Section -->
    <div class="analytics-container">
      <h2 class="analytics-title">📊 Statistik</h2>
      <div class="analytics-grid">
        <div class="stat-box">
          <div class="stat-label">Total Trade</div>
          <div id="totalTrades" class="stat-value">0</div>
          <div class="stat-subtext">Semua Transaksi</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Win</div>
          <div id="winTrades" class="stat-value winrate-value">0</div>
          <div class="stat-subtext">Transaksi Sukses</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Loss</div>
          <div id="lossTrades" class="stat-value lossrate-value">0</div>
          <div class="stat-subtext">Transaksi Gagal</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Winrate</div>
          <div id="winrate" class="stat-value winrate-value">0%</div>
          <div class="stat-subtext">Persentase Sukses</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Profit Factor</div>
          <div id="profitFactor" class="stat-value profit-factor-value">0.00</div>
          <div class="stat-subtext">Rasio Profit</div>
        </div>
      </div>
      
      <div class="analytics-chart">
        <div id="winBar" class="win-bar" style="width: 0%"></div>
        <div id="lossBar" class="loss-bar" style="width: 0%"></div>
      </div>
      <div class="chart-labels">
        <span>Win: <span id="winPercentage">0%</span></span>
        <span>Loss: <span id="lossPercentage">0%</span></span>
      </div>
    </div>
    
    <form id="tradeForm">
      <div class="input-row">
        <div>
          <label for="pair">🔗 Pair</label>
          <input type="text" id="pair" name="pair" placeholder="Contoh: XAUUSD" required />
        </div>
        <div class="date-wrapper">
          <label for="date">📅 Date</label>
          <input type="date" id="date" name="date" required />
        </div>
      </div>
      <div class="input-row">
        <div>
          <label for="session">🌍 Session</label>
          <select id="session" name="session" required>
            <option value="Asia">Asia</option>
            <option value="London">London</option>
            <option value="New York">New York</option>
          </select>
        </div>
        <div>
          <label for="entry">📝 Entry</label>
          <select id="entry" name="entry" required>
            <option value="Buy">Buy</option>
            <option value="Sell">Sell</option>
          </select>
        </div>
      </div>
      <div class="input-row">
        <div>
          <label for="wl">🏆 Win/Loss</label>
          <select id="wl" name="wl" required>
            <option value="Win">Win</option>
            <option value="Loss">Loss</option>
          </select>
        </div>
        <div>
          <label for="rr">⚖️ RR</label>
          <input type="text" id="rr" name="rr" placeholder="Contoh: 2:1" required />
        </div>
      </div>
      <div>
        <label for="note">🗒️ Reason</label>
        <textarea id="note" name="note" rows="3" placeholder="Tulis catatan tambahan..."></textarea>
      </div>
      <button type="submit">Simpan Trade</button>
    </form>

    <div class="table-wrapper">
        <table class="history-table">  
            <thead>
            <tr>
            <th>Pair</th>
            <th>Date</th>
            <th>Session</th>
            <th>Entry</th>
            <th>Win/Loss</th>
            <th>RR</th>
            <th>Reason</th>
            <th>Action</th>
            </tr>
             </thead>
             <tbody id="historyBody"></tbody>
        </table>
  </div>
  
 <!-- Modal Popup -->
    <div id="modal" class="modal" style="display: none;">
        <div class="modal-content">
            <button id="modalClose" class="modal-close" aria-label="Tutup modal">✖️</button>
            <textarea id="modalText" readonly rows="8" style="width: 100%; border-radius: 8px; border: 1px solid #ccc; padding: 10px; resize: vertical; font-family: inherit; font-size: 14px; box-sizing: border-box;"></textarea>
        </div>
    </div>


  <script>
    const form = document.getElementById('tradeForm');
    const historyBody = document.getElementById('historyBody');
    const modal = document.getElementById('modal');
    const modalText = document.getElementById('modalText');
    const modalClose = document.getElementById('modalClose');

    // Analytics elements
    const totalTradesEl = document.getElementById('totalTrades');
    const winTradesEl = document.getElementById('winTrades');
    const lossTradesEl = document.getElementById('lossTrades');
    const winrateEl = document.getElementById('winrate');
    const profitFactorEl = document.getElementById('profitFactor');
    const winBar = document.getElementById('winBar');
    const lossBar = document.getElementById('lossBar');
    const winPercentageEl = document.getElementById('winPercentage');
    const lossPercentageEl = document.getElementById('lossPercentage');

    let trades = JSON.parse(localStorage.getItem('trades')) || [];

    // Fungsi untuk memaksa input pair menjadi uppercase
    function forceUppercaseInput() {
      const pairInput = document.getElementById('pair');
      pairInput.addEventListener('input', function() {
        // Simpan posisi kursor saat ini
        const start = this.selectionStart;
        const end = this.selectionEnd;
        
        // Ubah value menjadi uppercase
        this.value = this.value.toUpperCase();
        
        // Kembalikan posisi kursor
        this.setSelectionRange(start, end);
      });
    }

    // Function to calculate analytics
    function calculateAnalytics() {
      const totalTrades = trades.length;
      const winTrades = trades.filter(trade => trade.wl === "Win").length;
      const lossTrades = totalTrades - winTrades;
      
      // Calculate winrate
      const winrate = totalTrades > 0 ? (winTrades / totalTrades * 100) : 0;
      
      // Calculate profit factor (assuming RR ratio)
      let totalWinRR = 0;
      let totalLossRR = 0;
      
      trades.forEach(trade => {
        if (trade.wl === "Win" && trade.rr) {
          const rrParts = trade.rr.split(':');
          if (rrParts.length === 2) {
            totalWinRR += parseFloat(rrParts[0]);
          }
        } else if (trade.wl === "Loss") {
          totalLossRR += 1; // Losses are always 1R
        }
      });
      
      const profitFactor = totalLossRR > 0 ? (totalWinRR / totalLossRR) : totalWinRR > 0 ? Infinity : 0;
      
      // Update analytics UI
      totalTradesEl.textContent = totalTrades;
      winTradesEl.textContent = winTrades;
      lossTradesEl.textContent = lossTrades;
      winrateEl.textContent = winrate.toFixed(1) + '%';
      
      if (winrate >= 50) {
        winrateEl.classList.add('winrate-value');
        winrateEl.classList.remove('lossrate-value');
      } else {
        winrateEl.classList.add('lossrate-value');
        winrateEl.classList.remove('winrate-value');
      }
      
      profitFactorEl.textContent = profitFactor === Infinity ? '∞' : profitFactor.toFixed(2);
      
      // Update chart
      const winPercentage = totalTrades > 0 ? (winTrades / totalTrades * 100) : 0;
      const lossPercentage = 100 - winPercentage;
      
      winBar.style.width = winPercentage + '%';
      lossBar.style.width = lossPercentage + '%';
      
      winPercentageEl.textContent = winPercentage.toFixed(1) + '%';
      lossPercentageEl.textContent = lossPercentage.toFixed(1) + '%';
    }

    function renderTrades() {
        historyBody.innerHTML = '';
        if (trades.length === 0) {
        historyBody.innerHTML = '<tr><td colspan="8">Belum ada history.</td></tr>';
        calculateAnalytics(); // Calculate analytics even with no trades
        return;
        }

          // Sorting trades by date descending (latest first)
        trades.sort((a, b) => new Date(b.date) - new Date(a.date));

        trades.forEach((data, index) => {
        const entryClass = data.entry === "Buy" ? "buy-box" : "sell-box";
        const wlClass = data.wl === "Win" ? "win-box" : "loss-box";

        const row = document.createElement('tr');

        let notePreview = data.note ? data.note : '';
     let noteDisplay = notePreview.length > 10 ? notePreview.substring(0, 10) + '...' : notePreview;

      row.innerHTML = `
      <td>${data.pair}</td>
      <td>${data.date}</td>
      <td>${data.session}</td>
      <td><span class="${entryClass}">${data.entry}</span></td>
      <td><span class="${wlClass}">${data.wl}</span></td>
      <td>${data.rr}</td>
      <td class="note-cell" data-index="${index}">${noteDisplay}</td>
      <td>
        <button class="action-btn" onclick="editTrade(${index})">✏️</button>
        <button class="action-btn" onclick="deleteTrade(${index})">🗑️</button>
      </td>
        `;
        historyBody.appendChild(row);
        });

        document.querySelectorAll('.note-cell').forEach(cell => {
        cell.addEventListener('click', function() {
      const idx = this.dataset.index;
      const fullNote = trades[idx].note || '(Tidak ada catatan tambahan)';
      modalText.value = fullNote;
      modal.style.display = 'flex';
        });
        });
        
        calculateAnalytics(); // Calculate analytics after rendering
    }


    function saveTrades() {
      localStorage.setItem('trades', JSON.stringify(trades));
      calculateAnalytics(); // Also update analytics when saving
    }

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const data = {
        pair: form.pair.value.toUpperCase(), // Konversi ke uppercase
        date: form.date.value,
        session: form.session.value,
        entry: form.entry.value,
        wl: form.wl.value,
        rr: form.rr.value,
        note: form.note.value.trim(),
      };

      if (form.dataset.editing) {
        trades[form.dataset.editing] = data;
        form.removeAttribute('data-editing');
      } else {
        trades.push(data);
      }

      saveTrades();
      renderTrades();
      form.reset();
    });

    function editTrade(index) {
      const data = trades[index];
      form.pair.value = data.pair; // Data sudah uppercase
      form.date.value = data.date;
      form.session.value = data.session;
      form.entry.value = data.entry;
      form.wl.value = data.wl;
      form.rr.value = data.rr;
      form.note.value = data.note || '';
      form.dataset.editing = index;
      
      // Scroll to form
      form.scrollIntoView({ behavior: 'smooth' });
    }

    function deleteTrade(index) {
      if (confirm("Yakin ingin menghapus trade ini?")) {
        trades.splice(index, 1);
        saveTrades();
        renderTrades();
      }
    }

    // Modal close event
    modalClose.addEventListener('click', () => {
      modal.style.display = 'none';
    });

    // klik luar modal juga untuk tutup
    window.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

  document.addEventListener('DOMContentLoaded', () => {
    const setTodayDate = () => {
        const today = new Date().toISOString().split('T')[0];
        const dateInput = document.getElementById('date');
        if (dateInput) dateInput.value = today;
    };

    setTodayDate();
    forceUppercaseInput(); // Aktifkan uppercase input
    renderTrades(); // Initialize analytics on load

    // Jika form disubmit, tetap set ulang date
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', () => {
            setTimeout(setTodayDate, 0); // Tunggu DOM update dulu
        });
    });

    // Jaga-jaga kalau ada reload manual dari JS
    window.addEventListener('pageshow', (event) => {
        if (event.persisted) {
            setTodayDate();
        }
    });
  });


    // Fixed RR validation to only accept "number:1" format
    const rrInput = document.getElementById('rr');
    rrInput.addEventListener('input', () => {
      const regex = /^\d+:1$/;
      if (!regex.test(rrInput.value)) {
        rrInput.setCustomValidity('Format RR harus "X:1", contoh 2:1');
      } else {
        rrInput.setCustomValidity('');
      }
    });

    renderTrades();
  </script>
</body>
</html>